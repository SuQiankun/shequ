<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Hello MUI</title>
		
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<script src="js/mui.min.js"></script>
		<script src="js/Common.js" type="text/javascript" charset="utf-8"></script>
		<link href="css/mui.min.css" rel="stylesheet" />
			<style type="text/css">
				.yl_txt { font-size: 17px; line-height: 37px; color: #222; }
			</style>
			<style>
			html,
			body {
				
			}
			.title {
				padding: 20px 15px 10px;
				color: #6d6d72;
				font-size: 15px;
				background-color: #fff;
			}
		</style>
	</head>
	<body >
		<div class="mui-content"  >
			<div class="mui-content"  >
				<div class="mui-card"  >
					<div class="mui-card-header">
						<h4 style="font-weight: normal;">
							<span style="font-size: 20px;" class="mui-icon mui-icon-search"></span>
							<span>搜索</span>
						</h4>
					</div>
					<div class="mui-card-content" >
						<form class="mui-input-group"  >
							<div class="mui-input-row" >
								<label style="width: 30%;" >社区</label>
								<select    style="width: 70%;" id="shequID" class="mui-btn-block" onchange="getWangge()" >
								</select>
							</div>
							<div class="mui-input-row" >
								<label style="width: 30%;" >网格</label>
								<select    style="width: 70%;" id="wangge" class="mui-btn-block" onchange="getXiaoquInfo()" >
										<option>请选择</option>
								</select>
							</div>
							<div class="mui-input-row">
								<label style="width: 30%;">小区</label>
								<select  style="width: 70%;" class="mui-btn-block" id="communityInfo" onchange="getBuildingInfo()">
								</select>
							</div>
							<div class="mui-input-row">
								<label style="width: 30%;">楼栋</label>
								<select   style="width: 70%;" id="LouDongID" class="mui-btn-block" onchange="getRoomInfo()">
								</select>
							</div>
							<div class="mui-input-row">
							<label style="width: 30%;">房号</label>
							<select  style="width: 70%;" id="FangHaoID" class="mui-btn-block">
							</select>
								</div>
							
						</form>
					</div>
					<div class="mui-card-footer">
						<div class="mui-button-row" style="margin: 0 auto;">
							<button type="submit" class="mui-btn mui-btn-primary" id="searchPersionList" >搜索</button>&nbsp;&nbsp;
							<!--<button type="submit" class="mui-btn mui-btn-primary" onclick="showhouseinfo()" >搜索房产</button>&nbsp;&nbsp;-->
							<button type="button" class="mui-btn mui-btn-danger" onclick="return false;">取消</button>
						</div>
					</div>
				</div>
			
				<!--  房产信息-->
				<div id="houselist" class="mui-content"  style="display: none;">
						<div class="mui-card">
							<div class="mui-card-header">
								<h4 style="font-weight: normal;"><span style="font-size: 20px;" class="mui-icon mui-icon-map"></span><span> &nbsp;&nbsp房产信息</span></h4></div>
							<div class="mui-card-content">
								<form class="mui-input-group">
									<div class="mui-input-row"><label style="width: 35%;">房主姓名</label>
										<p id="yz_name" class="yl_txt"></p>
									</div>
									<div class="mui-input-row"><label style="width: 35%;">联系电话</label>
										<p id="yz_phone" class="yl_txt"></p>
									</div>
									<div class="mui-input-row"><label style="width: 35%;">编号</label>
										<p id="yz_fcznum" class="yl_txt"></p>
									</div>
									<div class="mui-input-row"><label style="width: 35%;">登记地址</label>
										<p id="yz_add" class="yl_txt"></p>
									</div>
									<div class="mui-input-row"><label style="width: 35%;">房屋面积</label>
										<p id="yz_area" class="yl_txt"></p>
									</div>
									<div class="mui-input-row"><label style="width: 35%;">房间数量</label>
										<p id="yz_housecount" class="yl_txt"></p>
									</div>
									<div class="mui-input-row"><label style="width: 35%;">房屋属性</label>
												<p id="houseatt" class="yl_txt"></p>
									</div>
									<div class="mui-input-row"><label style="width: 35%;">房屋用途</label>
												<p id="houseuse" class="yl_txt"></p>
									</div>
									<div class="mui-input-row"><label style="width: 35%;">建筑结构</label>
												<p id="housestruct" class="yl_txt"></p>
									</div>
									<div class="mui-input-row"><label style="width: 35%;">房屋类型</label>
										<p id="housetype" class="yl_txt"></p>
									</div>
									<div class="mui-input-row"><label style="width: 35%;">住宅类别</label>
										<p id="housecategory" class="yl_txt"></p>
									</div>
										<div class="mui-input-row"><label style="width: 35%;">住房来源</label>
											<p id="housesurce" class="yl_txt"></p>
									</div>
									
								</form>
							</div>
							<div class="mui-card-footer">
								<div class="mui-button-row" style="margin: 0 auto;"><button type="button" class="mui-btn  mui-btn-primary mui-btn-outlined " onclick="changeHouseInfo()">修改</button>&nbsp;&nbsp;</div>
							</div>
						</div>
				</div>
				<!--房产信息 end -->
				
				
				<div id="personList" class="mui-content" >
				</div>
				
					<div class="mui-content-padded" > 
						<a id="from_1">
						<button onclick="addPersion()" style="padding: 10px 0; margin: 16px 0;" type="button" class="mui-btn mui-btn-primary mui-btn-block">
							新增成员
						</button>
						</a>
					</div>	
			</div>
		</div>
		
		<script src="js/mui.min.js">
		</script>
		<script src="js/jquery-3.2.0.min.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" src="js/Common.js"></script>	
		<script type="text/javascript" charset="utf-8">		
			//获取网格列表
			function getWangge(){
				var selected_val = document.getElementById('shequID').value;
				common.getWangge(selected_val,function(result){
					document.getElementById("wangge").innerHTML = result;
					getXiaoquInfo()
				});
			}
		//发送请求加载小区数据;
		function getXiaoquInfo(){
				var selected_val = document.getElementById('wangge').value;
				common.getXiaoqu(selected_val,function(result){
					document.getElementById("communityInfo").innerHTML = result;
					getBuildingInfo()
				});
		}
		//发送请求加载楼栋数据
		 function getBuildingInfo(){
				var selected_val = document.getElementById('communityInfo').value;
				common.getLoudong(selected_val,function(result){
					document.getElementById("LouDongID").innerHTML = result;
					getRoomInfo();
				});
		 }
		 //获取房间信息
		 function getRoomInfo(){
		 	var selected_val = document.getElementById('LouDongID').value;
		 	common.getRoomList(selected_val,function(result){
					document.getElementById("FangHaoID").innerHTML = result;
				});
		 }
		
		//二级页面返回后更新数据
		document.addEventListener('updateInfo', function() {
				searchPeoInfo();
		});		
		
		//执行搜索
		document.getElementById("searchPersionList").addEventListener('tap',function(){	
			searchPeoInfo();
		});


		function searchPeoInfo(){
	
				var selected_val = document.getElementById('FangHaoID').value;
				if (selected_val == null || selected_val ==undefined || selected_val == '') {
					mui.toast('请选择房间号');
					return false;
				}
				
				getHouseInfo(selected_val);
				
				mui.ajax(urlforapp+':8080/app?cmd=getlivepeoplebyhouseid&houseid='+selected_val,{
						dataType:'json',
						type:'get',
						success:function(data){
						peoListData = data;
						var area_name='' ;
						if(data.data.length<1){
							mui.toast('暂无人员');
							//如果没有列表,插入空内容
							document.getElementById("personList").innerHTML = '';
							return;}
						console.log(data.data[0].peo_name);
					// 拼接插入的 html
					for (i=0;i<data.data.length;i++) {
					//判断数据是否为空,如果为空,设置默认值;
					 var name = common.changestr(data.data[i].peo_name);
					 var sex = common.changestr(data.data[i].peo_sex);
					 var nation = common.changestr(data.data[i].peo_nation_id);
					 var relation = common.changestr(data.data[i].peo_yz_relation);
					 var idcard = common.changestr(data.data[i].peo_card_num);
					 var jg =common.changestr(data.data[i].peo_jg_id);
					 var phone =common.changestr(data.data[i].peo_phone);
					 var birth = common.changestr(data.data[i].peo_birthday);
					 var username = common.changestr(data.data[i].bhr_username);
					 var names =   common.changestr(data.data[i].bhr_names);
					 
					 var att = common.changestr(data.data[i].peo_attr_id);
					//重点人员标记
					var resultstr = checkPersonInfo(data.data[i].peo_attr_id,data.data[i].peoid,att);
					var titleStr =  creattitleStr(data.data[i].peo_attr_id);
					area_name
					+=
					titleStr
					+'<label style="width: 35%;">姓名</label><p class="yl_txt" id="'
					+data.data[i].peo_id+'name'
					+'">'
					+ name
					+'</p>'+'</div><div class="mui-input-row"><label style="width: 35%;">性别</label>'+'<p class="yl_txt" id="'
					+data.data[i].peo_id+'sex'
					+'">'
					+sex
					+'</p></div><div class="mui-input-row"><label style="width: 35%;">族别</label><p class="yl_txt" id="'
					+data.data[i].peo_id+'nation'
					+'">'
					+nation
					+'</p></div><div class="mui-input-row"><label style="width: 35%;">与业主关系</label><p class="yl_txt" id="'
					+data.data[i].peo_id+'relation'
					+'">'
					+relation
					+'</p></div><div class="mui-input-row"><label style="width: 35%;">身份证</label><p class="yl_txt" id="'
					+data.data[i].peo_id+'idcard'
					+'">'
					+idcard
					+'</p></div><div class="mui-input-row"><label style="width: 35%;">籍贯</label><p class="yl_txt" id="'
					+data.data[i].peo_id+'jg'
					+'">'
					+jg
					+'</p></div><div class="mui-input-row"><label style="width: 35%;">电话</label><p class="yl_txt" id="'
					+data.data[i].peo_id+'phone'
					+'">'
					+phone
					+'</p></div><div class="mui-input-row"><label style="width: 35%;">出生日期</label><p class="yl_txt" id="'
					+data.data[i].peo_id+'birth'
					+'">'
					+birth
//					+ resultstr
					+'</p></div><div class="mui-input-row"><label style="width: 35%;">网格员</label><p class="yl_txt">'
//					+username+':'
					+ names
					+'</p></div></form></div><div class="mui-card-footer"><div class="mui-button-row" style="margin: 0 auto;">'
					+'<button type="button" class="mui-btn mui-btn-primary mui-btn-outlined"  id="'
					+data.data[i].peo_id
					+'" onclick="changePersonInfo(this.id)">修改</button>&nbsp;&nbsp;</div></div></div>'
					;
				}
		
				//插入数据内容;
				document.getElementById("personList").innerHTML = area_name;
				},
				error: function(xhr,type,errorThrown){

				}
			});	
		}
		
		//更新字符串 --> 重点人员字符串处理
		function checkPersonInfo(data,peoid,att){
			var result = '';
			if (data == "" || data == undefined || data == null) {
				result = '</p></div><div class="mui-input-row"><label style="width: 35%;">备注</label><p class="yl_txt"  id="'
					+peoid+'att">'+att;
			} else{
				result = '</p></div><div class="mui-input-row"><label style="width: 35%;">备注</label><p class="yl_txt" style="color:#FF0000 ;" id="'
					+peoid+'att">'+att;
			}
			return result;
		}
		//更新字符串 --> 重点人员字符串处理
		function creattitleStr(att){
				var titleStr = '';
				//if (att == "" || att == undefined || att == null) {
			if (att == "重点户") {
				titleStr = '<div class="mui-card"><div class="mui-card-header"><h4 style="font-weight: normal;"><span style="font-size: 20px;" class="mui-icon mui-icon-map"></span><span style="color:#FF0000 ;" >&nbsp&nbsp当前住户</span></h4></div><div class="mui-card-content"><form class="mui-input-group"><div class="mui-input-row">';
			} else{
				titleStr = '<div class="mui-card"><div class="mui-card-header"><h4 style="font-weight: normal;"><span style="font-size: 20px;" class="mui-icon mui-icon-map"></span><span>&nbsp&nbsp当前住户</span></h4></div><div class="mui-card-content"><form class="mui-input-group"><div class="mui-input-row">';		
			}
			return titleStr;
			}
		//  获取房间
		function getHouseInfo(params){
			$('#houselist').show()
			console.log('房子 id'+params);
			mui.ajax(urlforapp+':8080/app?cmd=getfcinfobyhouseid&houseid='+params,{
				dataType:'json',//服务器返回json格式数据
				type:'get',//HTTP请求类型
				timeout:10000,//超时时间设置为10秒；
				success:function(data){
					houseData = data;
					document.getElementById("yz_name").innerText = common.changestr(data.data[0].yz_name);
					document.getElementById("yz_phone").innerText = common.changestr(data.data[0].tel);
					document.getElementById("yz_fcznum").innerText = common.changestr(data.data[0].fc_fcz_num); 
					document.getElementById("yz_add").innerText=common.changestr(data.data[0].fc_addr);
					document.getElementById("yz_area").innerText=common.changestr(data.data[0].fc_house_area);
					document.getElementById("yz_housecount").innerText=common.changestr(data.data[0].fc_house_room_num);
					
					document.getElementById("houseatt").innerText = common.changestr(data.data[0].fc_house_attr_id);
					document.getElementById("houseuse").innerText = common.changestr(data.data[0].fc_house_use_id);
					document.getElementById("housestruct").innerText = common.changestr(data.data[0].fc_house_structure_id);
					document.getElementById("housetype").innerText = common.changestr(data.data[0].fc_house_type_id);
					document.getElementById("housecategory").innerText = common.changestr(data.data[0].fc_house_category_id);
					document.getElementById("housesurce").innerText = common.changestr(data.data[0].fc_house_source_id);
				},
				error:function(xhr,type,errorThrown){
				}
			});
			
		}
		
		//跳转到新增人员的界面;
		function addPersion(){
				
				var shequ = document.getElementById('shequID').value;
				var wangge = document.getElementById("wangge").value;
				var xiaoqu = document.getElementById('communityInfo').value;
				var loudongid =document.getElementById("LouDongID").value;
				var fanghaoid =document.getElementById("FangHaoID").value;
				
				if (fanghaoid == '' || fanghaoid == null || fanghaoid == undefined) {
					mui.alert('请选择房间进行新增人员');
					return false;
				} else{
					mui.openWindow({
					    url: 'addPerson.html', 
					    id:'addPerson',
					     extras:{
							shequid:shequ,
							wanggeid:wangge,
							xiaoquid:xiaoqu,
							loudongid:loudongid,
							fanghaoid:fanghaoid
					    },
				     });
				}
			}
			
		//跳转到修改人员资料的界面,
		function changePersonInfo(peroid){
			
				var shequ = document.getElementById('shequID').value;
				var xiaoqu = document.getElementById('communityInfo').value;
				var loudongid =document.getElementById("LouDongID").value;
				var fanghaoid =document.getElementById("FangHaoID").value;
			
				var name =  document.getElementById(peroid+'name').textContent;
				var sex =  document.getElementById(peroid+'sex').textContent;
				var nation =  document.getElementById(peroid+'nation').textContent;
				var relation = document.getElementById(peroid+'relation').textContent;
				var idcard =  document.getElementById(peroid+'idcard').textContent;
				var jg =  	document.getElementById(peroid+'jg').textContent;
				var phone =  document.getElementById(peroid+'phone').textContent;
				var birth =  document.getElementById(peroid+'birth').textContent;
				//TODO 将获取到的 data 作为一个参数传递到另外一个页面;减少代码量
					mui.openWindow({
					    url: 'changePersonInfo.html', 
					    id:'changePersonInfo',
					    extras:{
					    		peoList:peoListData,
					    		shequid:shequ,
							xiaoquid:xiaoqu,
							loudongid:loudongid,
							fanghaoid:fanghaoid,
					    		personid:peroid,
							name:name,
							sex:sex,
							nation:nation,
							relation:relation,
							idcard:idcard,
							jg:jg,
							phone:phone,
							birth:birth,
					    },
				    });
		}
	
		//跳转到修改房产信息的列表
		
		function changeHouseInfo(){
			mui.openWindow({
		   		url: 'houseInfo.html', 
			    id:'changehouseinfo',
				extras:{
					housedata:houseData,
				},
			});
		}
	
	</script>	

	<script>
		
		
		mui.plusReady(function(){
			//开启回弹
			var placeholderText = '<option value="">请选择</option>';
			document.getElementById('shequID').innerHTML =placeholderText ;
			document.getElementById('communityInfo').innerHTML =placeholderText ;
			document.getElementById('LouDongID').innerHTML =placeholderText ;
			document.getElementById('FangHaoID').innerHTML =placeholderText ;
			
			//获取社区列表
			common.getSheQu(function(result){
				document.getElementById("shequID").innerHTML = result;
				getWangge();
			});
	});

	</script>
	</body>
</html>